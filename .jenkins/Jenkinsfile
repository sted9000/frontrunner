pipeline {
    agent any
    
    environment {
        // Store workspace path for reference
        PROJECT_ROOT = "${WORKSPACE}"
        APK_PATH = "${PROJECT_ROOT}/android/app/build/outputs/apk/debug/app-debug.apk"
        FLOW_PATH = "${PROJECT_ROOT}/.maestro/flow.yaml"
    }

    stages {
        stage('Setup Maestro') {
            steps {
                script {
                    // Print directories for debugging
                    sh '''
                        echo "Workspace: $WORKSPACE"
                        echo "Current directory: $(pwd)"
                        ls -la
                    '''
                    
                    def maestroInstalled = sh(
                        script: 'which maestro || true',
                        returnStdout: true
                    ).trim()

                    if (!maestroInstalled) {
                        echo "Maestro not found. Installing..."
                        sh '''
                            curl -Ls "https://get.maestro.mobile.dev" | bash
                            export PATH="$PATH:$HOME/.maestro/bin"
                        '''
                    } else {
                        echo "Maestro is already installed at: ${maestroInstalled}"
                    }
                }
            }
        }

        stage('Run Maestro Cloud Test') {
            steps {
                // Ensure we're in the project root
                dir("${PROJECT_ROOT}") {
                    sh '''
                        # Print current directory for verification
                        pwd
                        ls -la
                        
                        # Ensure Maestro is in PATH
                        export PATH="$PATH:$HOME/.maestro/bin"
                        
                        # Run test with absolute paths
                        maestro cloud "${APK_PATH}" "${FLOW_PATH}"
                    '''
                }
            }
        }
    }
}