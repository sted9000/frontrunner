// .jenkins/Jenkinsfile
pipeline {
    agent any
    
    environment {
        APK_PATH = '../android/app/build/outputs/apk/debug/app-debug.apk'
        FLOW_PATH = '../.maestro/flow.yaml'
        REQUIRED_MAESTRO_VERSION = '1.33.0'  // Specify your required version
    }

    stages {
        stage('Setup Maestro') {
            steps {
                script {
                    def installMaestro = false
                    
                    // Check if Maestro exists and get version
                    def currentVersion = sh(
                        script: '''
                            if command -v maestro >/dev/null 2>&1; then
                                maestro --version | grep -oE '[0-9]+\\.[0-9]+\\.[0-9]+'
                            else
                                echo "NOT_INSTALLED"
                            fi
                        ''',
                        returnStdout: true
                    ).trim()
                    
                    if (currentVersion == "NOT_INSTALLED") {
                        echo "Maestro not found. Installing..."
                        installMaestro = true
                    } else {
                        echo "Found Maestro version: ${currentVersion}"
                        
                        // Compare versions (simple string comparison - could be more sophisticated)
                        if (currentVersion < REQUIRED_MAESTRO_VERSION) {
                            echo "Maestro version ${currentVersion} is older than required ${REQUIRED_MAESTRO_VERSION}. Updating..."
                            installMaestro = true
                        }
                    }
                    
                    if (installMaestro) {
                        sh '''
                            curl -Ls "https://get.maestro.mobile.dev" | bash
                            export PATH="$PATH:$HOME/.maestro/bin"
                            maestro --version
                        '''
                    }
                }
            }
        }

        stage('Run Maestro Cloud Test') {
            steps {
                dir('..') {
                    sh '''
                        export PATH="$PATH:$HOME/.maestro/bin"
                        maestro cloud ${APK_PATH} ${FLOW_PATH}
                    '''
                }
            }
        }
    }
}